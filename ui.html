<h2>Set API key</h2>
<p>Find your API key on our <a href="https://visualeyes.loceye.io" class="anchor">website</a></p>
<p>API key: <input id="key" value=""></p>
<button id="set">Set</button>
<button id="cancel">Cancel</button>
<script>

  window.onmessage = async (event) => {
    const postMessage = msg => window.parent.postMessage({ pluginMessage: msg }, '*');

    const { type } = event.data.pluginMessage;
    //https://www.figma.com/plugin-docs/making-network-requests/
    if (type === 'postImage') {
      const { apiKey, image } = event.data.pluginMessage;

      var formData = new FormData()
      formData.append("image", image + "")
      formData.append("isTransparent", "true")
      // formData.append("platform", "figma")

      const token = "Token " + apiKey;
      const proxyUrl = "https://cors-anywhere.herokuapp.com/";
      // const proxyUrl = "";
      const apiUrl = "https://api.visualeyes.loceye.io/predict/"

      fetch(proxyUrl + apiUrl, {
        method: "POST",
        body: formData,
        headers: {
          "Authorization": token,
          "cache-control": "no-cache",
        },
      })

        .then((res) => {
          const { status } = res;

          try {
            if (status === 200) {
              return res.json();
            } else if (status === 400) {
              throw "ðŸ˜± We are deeply sorry, but something went terrible wrong!";
            } else if (status === 401) {
              throw "ðŸ™„ Your API key is not valid";
            } else if (status === 403) {
              throw "ðŸš¨ Your heatmaps limit has been exceeded";
            }
          }
          finally { }
        })
        .then(async (json) => {
          if (json.code !== "success") {
            throw new Error("Error during fetching the heatmap");
          }
          const heatmapUrl = json.url;

          const bytes = await new Promise((resolve, reject) => {
            const img = new window.Image();
            img.crossOrigin = "Anonymous";

            img.onload = () => {
              const { width, height } = img;
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d')
              canvas.width = width;
              canvas.height = height;

              context.clearRect(0, 0, canvas.width, canvas.height);
              context.drawImage(img, 0, 0, width, height);

              const imageData = context.getImageData(0, 0, width, height).data
              const arrayBuffer = imageData.buffer;
              const bytes = new Uint8Array(imageData)
              resolve(bytes);
            }
            img.onerror = () => reject(new Error(`Could not decode bytes due to an error`));
            img.src = proxyUrl + heatmapUrl;
          });

          postMessage({ type: 'heatmap', bytes });
        })
        .catch((error) => {
          postMessage({ type: 'request-error', error });
        })
    }
  }

  document.getElementById('set').onclick = () => {
    const textbox = document.getElementById('key');
    const apiKey = textbox.value
    parent.postMessage({ pluginMessage: { type: 'set-api-key', apiKey } }, '*')
  }

  document.getElementById('cancel').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
  }


</script>
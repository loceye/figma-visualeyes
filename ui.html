<link
  href="https://fonts.googleapis.com/css?family=Rubik:400,700&display=swap"
  rel="stylesheet"
/>
<style>
  * {
    font-family: "Rubik", sans-serif;
  }

  h2 {
    color: #212121;
  }

  p {
    font-size: 14px;
    color: #212121;
  }

  label {
    margin-right: 0.5rem;
    font-size: 10px;
    color: #666;
  }

  button {
    display: inline-block;
    -ms-flex-negative: 0;
    flex-shrink: 0;
    margin: 1px 0 1px 0;
    padding: 5px 16px 5px 16px;
    border: 2px solid transparent;
    border-radius: 6px;
    outline: none;
    font-weight: bold;
  }

  a {
    color: #5b42e3;
  }

  input {
    font-weight: 400;
    font-size: 11px;
    line-height: 16px;
    letter-spacing: 0.005em;
    position: relative;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    overflow: visible;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    width: 100%;
    height: 30px;
    margin: 1px 0 1px 0;
    padding: 8px 4px 8px 7px;
    color: #3e21de;
    border: 1px solid #e7e4fb;
    border-radius: 6px;
    outline: none;
    background-color: #e7e4fb;
  }

  input:hover {
    border: 1px solid #c3baf5;
  }

  input:active,
  input:focus {
    border: 1px solid #3e21de;
  }

  .primary {
    background-color: #3e21de;
    color: #fff;
    margin-left: 0.5rem;
  }

  .secondary {
    background-color: #e7e4fb;
    color: #3e21de;
  }

  .row {
    margin-bottom: 1rem;
  }

  .button-row {
    display: flex;
    flex-direction: row-reverse;
  }

  #link {
    color: #5b42e3;
    cursor: pointer;
  }
</style>

<h2>Set your API key</h2>
<p>Request your unique API key on <span id="link">our website.</span></p>
<div class="row"><label>API key:</label><input id="key" value="" /></div>
<div class="button-row">
  <button id="set" class="primary">Set</button>
  <button id="cancel" class="secondary">Cancel</button>
</div>

<script>
  window.onmessage = async event => {
    const postMessage = msg =>
      window.parent.postMessage({ pluginMessage: msg }, "*");

    const { type } = event.data.pluginMessage;
    if (type === "postImage") {
      const { apiKey, image, isLast, hasAOI, areas } = event.data.pluginMessage;

      var formData = new FormData();
      formData.append("image", image + "");
      formData.append("isTransparent", "true");
      formData.append("platform", "figma");
      if (hasAOI) {
        formData.append("aoi", JSON.stringify(areas));
      }

      const token = "Token " + apiKey;
      const apiUrl = "https://api.visualeyes.loceye.io/predict/";

      fetch(apiUrl, {
        method: "POST",
        body: formData,
        headers: {
          Authorization: token
          // "cache-control": "no-cache",
        }
      })
        .then(res => {
          const { status } = res;

          try {
            if (status === 200) {
              return res.json();
            } else if (status === 400) {
              throw "ðŸ˜± We are deeply sorry, but something went terrible wrong!";
            } else if (status === 401) {
              throw "ðŸ™„ Your API key is not valid";
            } else if (status === 403) {
              throw "ðŸš¨ Your heatmaps limit has been exceeded";
            }
          } finally {
          }
        })
        .then(async json => {
          if (json.code !== "success") {
            throw new Error("Error during fetching the heatmap");
          }
          const heatmapUrl = json.url;

          try {
            const bytes = await new Promise((resolve, reject) => {
              const img = new window.Image();
              img.crossOrigin = "Anonymous";

              img.onload = () => {
                const { width, height } = img;

                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.width = width;
                canvas.height = height;

                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(img, 0, 0, width, height);
                canvas.toBlob(blob => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(new Uint8Array(reader.result));
                  reader.onerror = () => reject("Could not read from blob");
                  reader.readAsArrayBuffer(blob);
                });
              };
              img.onerror = () =>
                reject(`Could not decode bytes due to an error`);
              img.src = heatmapUrl;
            });

            const scores = hasAOI
              ? JSON.parse(areas).map(area => ({
                  id: area.id,
                  score: Math.floor(Math.random() * Math.floor(100))
                }))
              : [];

            postMessage({
              type: "heatmap",
              bytes,
              shouldClose: isLast,
              scores
            });
          } finally {
          }
        })
        .catch(error => {
          postMessage({ type: "request-error", error });
        });
    } else if (type === "set-previous-api-key") {
      const { previousApiKey } = event.data.pluginMessage;

      const textbox = document.getElementById("key");
      textbox.value = previousApiKey;
    }
  };

  document.getElementById("link").onclick = () => {
    window.open(
      "https://visualeyes.loceye.io/subscribe.html?tool=figma",
      "_system"
    );
  };
  document.getElementById("set").onclick = () => {
    const textbox = document.getElementById("key");
    const apiKey = textbox.value;
    parent.postMessage({ pluginMessage: { type: "set-api-key", apiKey } }, "*");
  };
  document.getElementById("cancel").onclick = () => {
    parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
  };
</script>
